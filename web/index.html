<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MathGloss</title>
    <link rel="stylesheet" href="styles.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  </head>
  <body>
    <h1>MathGloss</h1>
    <div class="toolbar">
      <div class="group">
        <input id="search" type="text" placeholder="Search by label or QID" />
        <span id="counts" class="note"></span>
      </div>
      <div class="group">
        <label><input type="checkbox" id="hide-nlab-only" /> Hide nLab-only</label>
        <label><input type="checkbox" id="hide-planetmath-only" /> Hide PlanetMath-only</label>
      </div>
    </div>
    <div id="source-filters" class="controls"></div>

    <table id="entry-table">
      <thead>
        <tr>
          <th data-key="qid">Wikidata ID <span class="sort-ind"></span></th>
          <th data-key="label">Title <span class="sort-ind"></span></th>
          <th data-key="sources">Sources <span class="sort-ind"></span></th>
        </tr>
      </thead>
      <tbody id="entry-rows"></tbody>
    </table>

    <script>
      const PERMALINK_PREFIX = '../entries';
      const DEFAULT_DATASETS = ['database.csv', 'database_pruned.csv'];

      const datasetParam = new URLSearchParams(window.location.search).get('dataset');
      const queryDatasets = datasetParam
        ? datasetParam
            .split(',')
            .map((s) => s.trim())
            .filter(Boolean)
        : [];
      const overrideDatasets = Array.isArray(window.DATASET_FILES)
        ? window.DATASET_FILES.filter(Boolean)
        : [];
      const FALLBACK_FILES = Array.from(
        new Set([...queryDatasets, ...overrideDatasets, ...DEFAULT_DATASETS])
      );

      const searchInput = document.getElementById('search');
      const countsEl = document.getElementById('counts');
      const tbody = document.getElementById('entry-rows');
      const hideNlabOnlyEl = document.getElementById('hide-nlab-only');
      const hidePlanetOnlyEl = document.getElementById('hide-planetmath-only');
      const sourceFiltersEl = document.getElementById('source-filters');
      const headerCells = document.querySelectorAll('#entry-table thead th');

      let allRows = [];
      let sourcePairs = [];
      let activeSources = new Set();
      let lastFiltered = [];
      let sortState = { key: 'label', dir: 1 };

      const detectSourcePairs = (headers) => {
        const set = new Set(headers);
        return headers
          .filter((h) => h.endsWith(' Name'))
          .map((nameHeader) => {
            const base = nameHeader.slice(0, -5);
            const linkHeader = `${base} Link`;
            return set.has(linkHeader)
              ? { base, nameKey: nameHeader, linkKey: linkHeader }
              : null;
          })
          .filter(Boolean);
      };

      const entryPermalink = (qid) => `${PERMALINK_PREFIX}/${(qid || '').trim()}.html`;

      const enhanceRow = (row) => {
        const sourceSet = new Set();
        sourcePairs.forEach(({ base, nameKey, linkKey }) => {
          const name = (row[nameKey] || '').trim();
          const link = (row[linkKey] || '').trim();
          if (name && link) {
            sourceSet.add(base);
          }
        });
        row.__sourceSet = sourceSet;
        row.__sourceCount = sourceSet.size;
        row.__nlabOnly = sourceSet.size === 1 && sourceSet.has('nLab');
        row.__planetOnly = sourceSet.size === 1 && sourceSet.has('PlanetMath');
        return row;
      };

      const buildSourceFilters = () => {
        sourceFiltersEl.innerHTML = '';
        if (!sourcePairs.length) return;
        const heading = document.createElement('span');
        heading.textContent = 'Require sources:';
        heading.className = 'note';
        sourceFiltersEl.appendChild(heading);
        sourcePairs.forEach(({ base }) => {
          const label = document.createElement('label');
          label.className = 'toggle-column';
          const cb = document.createElement('input');
          cb.type = 'checkbox';
          cb.dataset.base = base;
          cb.addEventListener('change', () => {
            if (cb.checked) {
              activeSources.add(base);
            } else {
              activeSources.delete(base);
            }
            applyFilters();
          });
          label.appendChild(cb);
          label.appendChild(document.createTextNode(` ${base}`));
          sourceFiltersEl.appendChild(label);
        });
      };

      const rowMatchesSources = (row) => {
        for (const base of activeSources) {
          if (!row.__sourceSet.has(base)) return false;
        }
        return true;
      };

      const applyFilters = () => {
        const term = (searchInput.value || '').trim().toLowerCase();
        const hideNlab = hideNlabOnlyEl.checked;
        const hidePlanet = hidePlanetOnlyEl.checked;

        lastFiltered = allRows.filter((row) => {
          if (hideNlab && row.__nlabOnly) return false;
          if (hidePlanet && row.__planetOnly) return false;
          if (!rowMatchesSources(row)) return false;
          if (!term) return true;
          const qid = (row['Wikidata ID'] || '').toLowerCase();
          const label = (row['Wikidata Label'] || '').toLowerCase();
          return qid.includes(term) || label.includes(term);
        });

        countsEl.textContent = `Showing ${lastFiltered.length.toLocaleString()} of ${allRows.length.toLocaleString()} entries`;
        renderRows(lastFiltered);
      };

      const compareRows = (a, b) => {
        const dir = sortState.dir;
        switch (sortState.key) {
          case 'qid': {
            const av = (a['Wikidata ID'] || '').toUpperCase();
            const bv = (b['Wikidata ID'] || '').toUpperCase();
            return av.localeCompare(bv) * dir;
          }
          case 'sources': {
            const av = a.__sourceCount || 0;
            const bv = b.__sourceCount || 0;
            if (av === bv) {
              const labelA = (a['Wikidata Label'] || '').toLowerCase();
              const labelB = (b['Wikidata Label'] || '').toLowerCase();
              return labelA.localeCompare(labelB) * dir;
            }
            return (av - bv) * dir;
          }
          case 'label':
          default: {
            const av = (a['Wikidata Label'] || '').toLowerCase();
            const bv = (b['Wikidata Label'] || '').toLowerCase();
            const primary = av.localeCompare(bv);
            if (primary !== 0) return primary * dir;
            const qidA = (a['Wikidata ID'] || '').toUpperCase();
            const qidB = (b['Wikidata ID'] || '').toUpperCase();
            return qidA.localeCompare(qidB) * dir;
          }
        }
      };

      const renderRows = (rows) => {
        const sorted = rows.slice().sort(compareRows);
        tbody.innerHTML = '';
        const frag = document.createDocumentFragment();
        sorted.forEach((row) => {
          const qid = (row['Wikidata ID'] || '').trim();
          if (!qid) return;
          const label = (row['Wikidata Label'] || qid).trim();
          const tr = document.createElement('tr');

          const tdQid = document.createElement('td');
          tdQid.textContent = qid;
          tr.appendChild(tdQid);

          const tdTitle = document.createElement('td');
          const link = document.createElement('a');
          link.href = entryPermalink(qid);
          link.textContent = label;
          link.title = `${label} — ${qid}`;
          tdTitle.appendChild(link);
          tr.appendChild(tdTitle);

          const tdCount = document.createElement('td');
          tdCount.textContent = String(row.__sourceCount || 0);
          tr.appendChild(tdCount);

          frag.appendChild(tr);
        });
        tbody.appendChild(frag);
        updateSortIndicators();
      };

      const updateSortIndicators = () => {
        headerCells.forEach((th) => {
          const span = th.querySelector('.sort-ind');
          if (!span) return;
          const key = th.dataset.key;
          if (key === sortState.key) {
            span.textContent = sortState.dir > 0 ? '▲' : '▼';
          } else {
            span.textContent = '';
          }
        });
      };

      const parseCsv = (path, onOk, onErr) => {
        Papa.parse(path, {
          download: true,
          header: true,
          dynamicTyping: false,
          skipEmptyLines: true,
          complete: (results) => onOk(results),
          error: (err) => onErr(err),
        });
      };

      const loadData = () => {
        countsEl.textContent = 'Loading…';
        const here = window.location.pathname || '';
        const idx = here.lastIndexOf('/web/');
        let base = null;
        if (idx >= 0) base = here.substring(0, idx);
        const cacheBust = (u) => u + (u.includes('?') ? '&' : '?') + 'v=' + Date.now();
        const candidates = [];
        for (const file of FALLBACK_FILES) {
          if (base) candidates.push(cacheBust(`${base}/data/${file}`));
          candidates.push(cacheBust('data/' + file));
          candidates.push(cacheBust('../data/' + file));
        }

        const tried = [];
        const attempt = () => {
          if (!candidates.length) {
            const msg = 'Unable to load dataset: ' + tried.join(', ');
            countsEl.textContent = msg;
            console.error(msg);
            return;
          }
          const next = candidates.shift();
          tried.push(next);
          parseCsv(next, (results) => {
            const rows = results.data.filter((row) => (row['Wikidata ID'] || '').trim());
            if (!rows.length) {
              attempt();
              return;
            }
            sourcePairs = detectSourcePairs(results.meta.fields || []);
            activeSources = new Set();
            allRows = rows.map(enhanceRow);
            buildSourceFilters();
            applyFilters();
          }, (err) => {
            console.warn('Failed to load', next, err);
            attempt();
          });
        };
        attempt();
      };

      searchInput.addEventListener('input', applyFilters);
      hideNlabOnlyEl.addEventListener('change', applyFilters);
      hidePlanetOnlyEl.addEventListener('change', applyFilters);

      headerCells.forEach((th) => {
        const key = th.dataset.key;
        if (!key) return;
        th.style.cursor = 'pointer';
        th.addEventListener('click', () => {
          if (sortState.key === key) {
            sortState.dir *= -1;
          } else {
            sortState = { key, dir: key === 'sources' ? -1 : 1 };
          }
          renderRows(lastFiltered);
        });
      });

      loadData();
    </script>
  </body>
</html>
