<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MathGloss</title>
    <link rel="stylesheet" href="styles.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  </head>
  <body>
    <h1>MathGloss</h1>
    <div class="toolbar">
      <div class="group">
        <input id="search" type="text" placeholder="Search by label or QID" />
        <span id="counts" class="note"></span>
      </div>
    </div>

    <table id="entry-table">
      <thead>
        <tr>
          <th>Wikidata ID</th>
          <th>Title</th>
          <th>Sources</th>
        </tr>
      </thead>
      <tbody id="entry-rows"></tbody>
    </table>

    <script>
      const PERMALINK_PREFIX = '/entries';
      const FALLBACK_FILES = ['database_compiled_pruned.csv', 'database_pruned.csv'];

      let allRows = [];
      let sourcePairs = [];

      const searchInput = document.getElementById('search');
      const countsEl = document.getElementById('counts');
      const tbody = document.getElementById('entry-rows');

      const detectSourcePairs = (headers) => {
        const set = new Set(headers);
        return headers
          .filter((h) => h.endsWith(' Name'))
          .map((nameHeader) => {
            const base = nameHeader.slice(0, -5);
            const linkHeader = `${base} Link`;
            return set.has(linkHeader) ? [base, nameHeader, linkHeader] : null;
          })
          .filter(Boolean);
      };

      const countSources = (row) => {
        let total = 0;
        for (const [, nameKey, linkKey] of sourcePairs) {
          const name = (row[nameKey] || '').trim();
          const link = (row[linkKey] || '').trim();
          if (name && link) total += 1;
        }
        return total;
      };

      const entryPermalink = (qid) => `${PERMALINK_PREFIX}/${(qid || '').trim()}.html`;

      const renderRows = (rows) => {
        tbody.innerHTML = '';
        const frag = document.createDocumentFragment();
        rows.forEach((row) => {
          const qid = (row['Wikidata ID'] || '').trim();
          if (!qid) return;
          const label = (row['Wikidata Label'] || qid).trim();
          const count = countSources(row);

          const tr = document.createElement('tr');

          const tdQid = document.createElement('td');
          tdQid.textContent = qid;
          tr.appendChild(tdQid);

          const tdTitle = document.createElement('td');
          const link = document.createElement('a');
          link.href = entryPermalink(qid);
          link.textContent = label;
          link.title = `${label} — ${qid}`;
          tdTitle.appendChild(link);
          tr.appendChild(tdTitle);

          const tdCount = document.createElement('td');
          tdCount.textContent = String(count);
          tr.appendChild(tdCount);

          frag.appendChild(tr);
        });
        tbody.appendChild(frag);
      };

      const applyFilter = () => {
        const term = (searchInput.value || '').trim().toLowerCase();
        if (!term) {
          renderRows(allRows);
          countsEl.textContent = `Showing ${allRows.length.toLocaleString()} entries`;
          return;
        }

        const filtered = allRows.filter((row) => {
          const qid = (row['Wikidata ID'] || '').toLowerCase();
          const label = (row['Wikidata Label'] || '').toLowerCase();
          return qid.includes(term) || label.includes(term);
        });
        renderRows(filtered);
        countsEl.textContent = `Showing ${filtered.length.toLocaleString()} of ${allRows.length.toLocaleString()} entries`;
      };

      const parseCsv = (path, onOk, onErr) => {
        Papa.parse(path, {
          download: true,
          header: true,
          dynamicTyping: false,
          skipEmptyLines: true,
          complete: (results) => onOk(results),
          error: (err) => onErr(err),
        });
      };

      const loadData = () => {
        countsEl.textContent = 'Loading…';
        const here = window.location.pathname || '';
        const idx = here.lastIndexOf('/web/');
        let base = null;
        if (idx >= 0) base = here.substring(0, idx);
        const cacheBust = (u) => u + (u.includes('?') ? '&' : '?') + 'v=' + Date.now();
        const candidates = [];
        for (const file of FALLBACK_FILES) {
          if (base) candidates.push(cacheBust(`${base}/data/${file}`));
          candidates.push(cacheBust('data/' + file));
          candidates.push(cacheBust('../data/' + file));
        }

        const tried = [];
        const attempt = () => {
          if (!candidates.length) {
            const msg = 'Unable to load dataset: ' + tried.join(', ');
            countsEl.textContent = msg;
            console.error(msg);
            return;
          }
          const next = candidates.shift();
          tried.push(next);
          parseCsv(next, (results) => {
            const rows = results.data.filter((row) => (row['Wikidata ID'] || '').trim());
            if (!rows.length) {
              attempt();
              return;
            }
            allRows = rows;
            sourcePairs = detectSourcePairs(results.meta.fields || []);
            allRows.sort((a, b) => {
              const labelA = (a['Wikidata Label'] || '').toLowerCase();
              const labelB = (b['Wikidata Label'] || '').toLowerCase();
              if (labelA && labelB) {
                const cmp = labelA.localeCompare(labelB);
                if (cmp !== 0) return cmp;
              }
              return (a['Wikidata ID'] || '').localeCompare(b['Wikidata ID'] || '');
            });
            renderRows(allRows);
            countsEl.textContent = `Showing ${allRows.length.toLocaleString()} entries`;
          }, (err) => {
            console.warn('Failed to load', next, err);
            attempt();
          });
        };
        attempt();
      };

      searchInput.addEventListener('input', applyFilter);
      loadData();
    </script>
  </body>
</html>
