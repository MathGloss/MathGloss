<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MathGloss 2</title>
    <link rel="stylesheet" href="styles.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  </head>
  <body>
    <h1>MathGloss 2</h1>
    <p>
      This is a clean slate. The table below reads from
      <code>../data/database.csv</code>.
    </p>

    <div id="toggle-buttons" class="controls"></div>
    <table id="glossary">
      <thead><tr id="headers"></tr></thead>
      <tbody id="rows"></tbody>
    </table>

    <script>
      function escapeHtml(s) { return s ? s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])) : ''; }

      function buildTable(data) {
        const table = document.getElementById('glossary');
        const headers = Object.keys(data[0] || {});

        // headers
        const thead = document.getElementById('headers');
        thead.innerHTML = '';
        headers.forEach((h, i) => {
          const th = document.createElement('th');
          th.textContent = h;
          th.dataset.col = i;
          thead.appendChild(th);
          // toggles
          const label = document.createElement('label');
          label.className = 'toggle-column';
          const cb = document.createElement('input');
          cb.type = 'checkbox';
          cb.checked = true;
          cb.dataset.col = i;
          cb.addEventListener('change', () => toggleColumn(i, cb.checked));
          label.appendChild(cb);
          label.appendChild(document.createTextNode(' ' + h));
          document.getElementById('toggle-buttons').appendChild(label);
        });

        // rows
        const tbody = document.getElementById('rows');
        tbody.innerHTML = '';
        data.forEach((row) => {
          const tr = document.createElement('tr');
          headers.forEach((h) => {
            const td = document.createElement('td');
            const val = row[h] || '';
            // If this is a "<Source> Name" and matching "<Source> Link" exists, render Name as clickable
            if (h.endsWith(' Name')) {
              const base = h.slice(0, -5);
              const linkKey = base + ' Link';
              const link = row[linkKey];
              if (val && link) {
                td.innerHTML = `<a href="${escapeHtml(link)}" target="_blank" rel="noopener">${escapeHtml(val)}</a>`;
              } else {
                td.textContent = val;
              }
            } else if (h.endsWith(' Link') && val) {
              td.innerHTML = `<a href="${escapeHtml(val)}" target="_blank" rel="noopener">${escapeHtml(val)}</a>`;
            } else {
              td.textContent = val;
            }
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });
      }

      function toggleColumn(idx, visible) {
        const table = document.getElementById('glossary');
        const rows = table.querySelectorAll('tr');
        rows.forEach((tr) => {
          const cell = tr.children[idx];
          if (cell) cell.style.display = visible ? '' : 'none';
        });
      }

      Papa.parse('../data/database.csv', {
        download: true,
        header: true,
        dynamicTyping: false,
        skipEmptyLines: true,
        complete: (results) => {
          const data = results.data;
          buildTable(data);
        },
        error: (err) => console.error('CSV load error', err),
      });
    </script>
  </body>
  </html>
